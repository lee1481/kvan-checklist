# 케이밴 제품 시공 점검표 웹앱 📋📸

## 프로젝트 개요
케이밴 제품 시공 점검표를 디지털화한 **태블릿 최적화 웹 애플리케이션**입니다. 
현장에서 터치로 체크하고, **사진을 첨부**하고, 디지털 서명 후 고객 이메일로 자동 발송하는 스마트 점검표 시스템입니다.

## ✅ 완료된 기능

### 1. 태블릿 친화적 UI
- ✅ 큰 터치 영역의 체크박스 (50x50px)
- ✅ 반응형 디자인 (모바일/태블릿 최적화)
- ✅ 터치 피드백 애니메이션
- ✅ 확대/축소 방지 (user-scalable=no)

### 2. 시공 정보 입력 폼
- ✅ 시공일자 (Date picker)
- ✅ 차량 차대번호
- ✅ 제품 시공명
- ✅ **제품 구성 (체크박스 선택)** 🆕
  - 기아PV5 스마트패키지
  - 기아PV5 워크스테이션
  - PV5 기아 3단부품선반
  - PV5 기아 3단선반
  - PV5 밀워키 스마트에디션
  - PV5 밀워키 워크스테이션
  - PV5 밀워키 3단부품선반
  - PV5 밀워키 3단선반
  - **기타 (직접 입력)** 옵션 제공

### 3. 점검 체크리스트
다음 6개 섹션으로 구성:
- ✅ 차바닥 (태고합판, 알루미늄체크판, 부자재)
- ✅ 격벽타공판
- ✅ 격벽 2단 선반
- ✅ 3단 선반 (휠 좌측/우측)
- ✅ 부품 3단 선반 (휠 좌측/우측)
- ✅ 워크스페이스 (휠 우측)

### 4. 📸 사진 첨부 기능 (섹션별 다중 업로드)
- ✅ **섹션별 통합 사진 버튼**
  - 각 섹션 제목 옆에 녹색 "사진" 버튼
  - 여러 장 동시 선택 가능 (multiple 속성)
  - 섹션별로 사진 그룹화 관리
- ✅ **이미지 자동 압축 및 최적화**
  - 최대 1200px로 자동 리사이징
  - JPEG 품질 80%로 압축
  - 5MB 파일 크기 제한
- ✅ **썸네일 미리보기**
  - 업로드한 사진 즉시 썸네일 표시 (24x24)
  - 클릭하면 전체 화면으로 확대
  - X 버튼으로 개별 사진 삭제 가능
- ✅ **섹션별 사진 관리**
  - 각 섹션마다 독립적으로 여러 장 관리
  - 섹션 제목 아래 사진 모음 표시

### 5. 디지털 서명 기능
- ✅ Canvas 기반 서명 패드
- ✅ 시공자 서명 (이름 + 서명)
- ✅ 고객 서명 (이름 + 이메일 + 서명)
- ✅ 서명 지우기 기능
- ✅ 마우스 및 터치 입력 지원
- ✅ **좌표 정확도 개선 (v1.7.0)** 🆕
  - Canvas scale 비율 자동 계산
  - 마우스/터치 커서와 그려지는 선 정확히 일치
  - 모든 화면 크기에서 정확한 서명 가능

### 6. 📧 이메일 발송 기능 (v1.4.0)
- ✅ **동시에 최대 3개 이메일 주소로 발송 가능**
  - 이메일 주소 1: 필수 입력
  - 이메일 주소 2: 선택 입력
  - 이메일 주소 3: 선택 입력
- ✅ Resend API 통합 완료
- ✅ HTML 이메일 템플릿 (CID 첨부 방식)
- ✅ 서명 및 사진 이메일 첨부
- ✅ 발송 성공 시 이메일 개수 표시

### 7. 📄 PDF 다운로드 기능 (v1.5.0)
- ✅ **클라이언트 사이드 PDF 생성**
  - 점검표 전체 내용 포함 (시공 정보, 체크리스트, 사진, 서명)
  - A4 포맷, 고품질 이미지 (scale: 2)
  - 파일명 자동 생성: `케이밴_점검표_{차대번호}_{날짜}.pdf`
- ✅ **독립 버튼 제공 (v1.6.0)**
  - 📧 이메일 발송 버튼: 이메일만 발송
  - 📄 PDF 다운로드 버튼: PDF만 다운로드
  - 가로 2단 레이아웃 (태블릿 최적화)
  - 사용자 선택권 강화 (confirm 다이얼로그 제거)
- ✅ **모바일 최적화 (v1.6.1)** 🆕
  - iOS/Android 자동 감지
  - 모바일: Blob URL 방식 (메모리 최적화, scale: 1)
  - 데스크톱: pdf.save() 방식 (고해상도, scale: 2)
  - iOS Files 앱 및 Android Downloads 폴더 호환
- ✅ **보관 및 출력 최적화**
  - 프린터 출력 최적화 (page-break-inside: avoid)
  - 장기 보관용 고품질 PDF
  - A/S 증빙 자료로 활용 가능

### 8. 폼 유효성 검증
- ✅ 필수 항목 입력 확인
- ✅ 이메일 형식 검증
- ✅ 서명 완료 여부 확인
- ✅ 사용자 친화적 오류 메시지
- ✅ 공통 검증 함수 (validateForm)

### 9. API 엔드포인트
- ✅ `POST /api/submit` - 점검표 제출 (사진 포함, 다중 이메일 발송)

## 🚧 구현 예정 기능

### 1. 데이터 저장 (선택적)
- ⏳ Cloudflare D1 데이터베이스 통합
- ⏳ Cloudflare R2 Storage (사진 저장)
- ⏳ 점검표 이력 조회
- ⏳ 통계 대시보드

### 2. 추가 기능
- ⏳ 오프라인 모드 (Service Worker)
- ⏳ 다국어 지원 (영문/중문)
- ⏳ QR 코드 생성 (점검표 링크 공유)
- ⏳ 일괄 사진 다운로드

## 📡 현재 접속 URL

### 프로덕션 (Cloudflare Pages)
- **URL**: https://kvan-checklist.pages.dev ⭐
- **상태**: ✅ 활성
- **용도**: 실제 사용 (Production)
- **최신 기능**: 📸 사진 첨부 + 📧 이메일 발송 + 📄 PDF 다운로드 + ✍️ 정확한 서명!

### 개발 서버 (Sandbox)
- **URL**: https://3000-iw3be9zf2hohe1e3yfcxw-c81df28e.sandbox.novita.ai
- **상태**: ✅ 활성
- **용도**: 개발 및 테스트

## 🛠️ 기술 스택

### Frontend
- **HTML5** - 시맨틱 마크업
- **Tailwind CSS** - 스타일링 (CDN)
- **Vanilla JavaScript** - 인터랙티브 기능
- **Canvas API** - 디지털 서명
- **FileReader API** - 이미지 업로드 및 압축
- **Axios** - HTTP 클라이언트

### Backend
- **Hono** - 경량 웹 프레임워크
- **Cloudflare Workers** - Edge 런타임
- **Wrangler** - CLI 도구

### 개발 도구
- **Vite** - 빌드 도구
- **PM2** - 프로세스 관리 (개발 환경)
- **Git** - 버전 관리

## 📦 데이터 구조

### 점검표 제출 데이터
```json
{
  "installDate": "2026-01-28",
  "vehicleVin": "KMHXX00XXXX000000",
  "productName": "케이밴 풀 패키지",
  "productConfig": "차바닥, 격벽타공판, 2단선반, 3단선반",
  "installerName": "홍길동",
  "customerName": "김철수",
  "customerEmail": "customer@example.com",
  "emailList": ["customer@example.com", "manager@example.com", "admin@example.com"],
  "checklist": {
    "0": {
      "0": true,
      "1": true,
      "2": false,
      "3": true
    }
  },
  "installerSignature": "data:image/png;base64,...",
  "customerSignature": "data:image/png;base64,...",
  "photos": {
    "section-0": [
      { "id": "photo-001", "data": "data:image/jpeg;base64,..." },
      { "id": "photo-002", "data": "data:image/jpeg;base64,..." }
    ],
    "section-1": [
      { "id": "photo-003", "data": "data:image/jpeg;base64,..." }
    ]
  }
}
```

### 사진 데이터 구조
- **키 형식**: `"section-{섹션인덱스}"` (예: "section-0", "section-1")
- **값 형식**: 사진 객체 배열 `[{id: "photo-001", data: "data:image/jpeg;base64,..."}]`
- **섹션별 다중 사진**: 각 섹션마다 여러 장의 사진 첨부 가능
- **압축**: 최대 1200px, 품질 80%
- **최대 크기**: 원본 5MB 제한

### 이메일 발송 구조
- **emailList**: 최대 3개 이메일 주소 배열
- **customerEmail**: 하위 호환성을 위한 첫 번째 이메일 (선택)
- **Resend API**: `to` 필드에 배열로 전달하여 동시 발송

## 🚀 로컬 개발 가이드

### 1. 프로젝트 시작
```bash
cd /home/user/webapp
npm install
```

### 2. 빌드
```bash
npm run build
```

### 3. 개발 서버 시작
```bash
# PM2로 시작 (권장)
pm2 start ecosystem.config.cjs

# 또는 직접 실행
npm run dev:sandbox
```

### 4. 테스트
```bash
curl http://localhost:3000
```

### 5. 로그 확인
```bash
pm2 logs kvan-checklist --nostream
```

## 📸 사진 첨부 사용 가이드

### 시공자/사용자용
1. **사진 촬영/업로드**
   - 각 점검 항목 옆의 🟢 카메라 버튼 클릭
   - 모바일: 카메라 앱 자동 실행
   - PC/태블릿: 파일 선택 대화상자
   
2. **사진 미리보기**
   - 업로드 후 자동으로 미리보기 표시
   - 사진 클릭하면 전체 화면으로 확대
   
3. **사진 삭제**
   - 미리보기 우측 상단 ❌ 버튼 클릭
   - 확인 후 삭제
   
4. **사진 첨부 상태 확인**
   - 카메라 버튼이 녹색으로 변경되면 업로드 완료
   - 여러 항목에 사진 첨부 가능

### 기술 세부사항
- **자동 압축**: 큰 사진도 자동으로 최적화
- **빠른 업로드**: Base64 인코딩으로 즉시 처리
- **메모리 효율**: 압축 후 평균 200-500KB
- **오류 처리**: 5MB 초과 시 자동 경고

## 📧 이메일 발송 설정 가이드 (다음 단계)

### 필요한 API 키
1. **Resend API** (추천)
   - https://resend.com 가입
   - API 키 생성
   - 도메인 인증 (선택적)

2. **SendGrid API** (대안)
   - https://sendgrid.com 가입
   - API 키 생성

### 환경 변수 설정
```bash
# .dev.vars 파일 생성
RESEND_API_KEY=re_xxxxxxxxxxxxx
FROM_EMAIL=noreply@yourdomain.com
```

### Cloudflare Pages 배포 시
```bash
# Secret 등록
wrangler pages secret put RESEND_API_KEY --project-name kvan-checklist
wrangler pages secret put FROM_EMAIL --project-name kvan-checklist
```

## 📋 사용 가이드

### 시공자용
1. 웹앱 접속 (태블릿 권장)
2. 시공 정보 입력
   - 시공일자, 차대번호 입력
   - 제품 시공명: 체크박스로 선택 (기아PV5, 밀워키PV5 등)
3. 각 섹션별 점검 항목 체크
   - 완료된 항목을 터치하여 체크 (✅)
4. 📸 **사진 첨부** (섹션별)
   - 각 섹션 제목 옆 "사진" 버튼 클릭
   - 여러 장 동시 선택 가능
   - 카메라 직접 실행 또는 갤러리에서 선택
   - 썸네일로 확인, 클릭하면 전체 화면 보기
5. 시공자 정보 및 서명
   - 이름 입력 후 서명 패드에 서명
6. 📧 **고객 정보 및 이메일 입력**
   - 고객 이름 입력
   - **이메일 주소 1 (필수)**: 반드시 입력
   - **이메일 주소 2 (선택)**: 추가 수신자
   - **이메일 주소 3 (선택)**: 추가 수신자
   - 고객 서명 받기
7. **작업 완료 - 2가지 옵션 선택**
   - **📧 이메일 발송 버튼**: 입력된 모든 이메일로 즉시 발송
   - **📄 PDF 다운로드 버튼**: PDF 파일만 생성 및 다운로드
   - **또는 둘 다**: 이메일 발송 후 PDF 다운로드 가능
8. **결과 확인**
   - 이메일 발송 시: "3개 이메일로 발송되었습니다!" 알림
   - PDF 다운로드 시: 파일 자동 저장 (`케이밴_점검표_{차대번호}_{날짜}.pdf`)

### 고객용
1. 이메일 수신
   - HTML 형식의 점검표 (CID 첨부 방식)
   - **시공 사진들이 이메일에 직접 표시**
   - 시공자 및 고객 서명 포함
2. PDF 다운로드 및 보관 (선택사항)
   - 시공자가 전달한 PDF 파일 보관
   - 또는 이메일을 PDF로 인쇄 저장
   - A/S 및 보증 관련 증빙 자료로 활용
3. 여러 명 동시 수신 가능
   - 고객, 담당자, 본사 등 최대 3명

## 🔐 보안 고려사항

- ✅ HTTPS 통신 (Cloudflare Pages 기본 제공)
- ✅ CORS 설정 (API 라우트만 허용)
- ✅ 이메일 형식 검증
- ✅ 파일 크기 제한 (5MB)
- ✅ 이미지 형식 검증 (accept="image/*")
- ⏳ Rate Limiting (구현 예정)
- ⏳ API 키 보안 관리 (Cloudflare Secrets)

## 📊 다음 개발 단계

### Phase 1: 이메일 발송 + PDF 생성 ✅ 완료!
1. ✅ Resend API 통합
2. ✅ HTML 이메일 템플릿 작성 (CID 첨부 방식)
3. ✅ 다중 이메일 발송 (최대 3개)
3. PDF 생성 라이브러리 통합 (jsPDF)
4. **사진이 포함된 PDF 생성**
5. 테스트 및 디버깅

### Phase 2: 데이터 저장 (2-3일)
1. Cloudflare D1 데이터베이스 설정
2. **Cloudflare R2 Storage (사진 저장)**
3. 점검표 저장 로직 구현
4. 조회 API 개발
5. 관리자 대시보드 (간단한 버전)

### Phase 3: 추가 기능 (3-5일)
1. 오프라인 모드 (Service Worker)
2. QR 코드 생성
3. 통계 및 리포트
4. 사진 일괄 다운로드

## 🎉 최신 업데이트 (v1.7.0)

### 2026-01-31: 서명 캔버스 좌표 정확도 개선! ✍️ (v1.7.0)
- ✅ Canvas scale 비율 자동 계산
  - `scaleX = canvas.width / rect.width`
  - `scaleY = canvas.height / rect.height`
- ✅ 마우스/터치 좌표 정확한 변환
  - `actualX = (clientX - rect.left) * scaleX`
  - `actualY = (clientY - rect.top) * scaleY`
- ✅ 커서 위치와 그려지는 선 정확히 일치
- ✅ 모든 화면 크기에서 정확한 서명 가능
- ✅ 손글씨처럼 자연스러운 서명 경험

### 2026-01-31: 모바일 PDF 다운로드 최적화! 📱 (v1.6.1)
- ✅ 디바이스 자동 감지 (iPhone/iPad/iPod/Android)
- ✅ 모바일 Blob URL 방식
  - `pdf.output('blob')` + `URL.createObjectURL()`
  - `<a>` 태그 download 속성 사용
- ✅ 모바일 메모리 최적화 (scale: 1)
- ✅ 데스크톱 고해상도 유지 (scale: 2)
- ✅ iOS Files 앱 및 Android Downloads 폴더 호환

### 2026-01-31: 이메일 발송과 PDF 다운로드 버튼 분리! 🎨 (v1.6.0)
- ✅ 독립 버튼 2개로 분리
  - 📧 **이메일 발송 버튼** (파란색): 이메일만 발송
  - 📄 **PDF 다운로드 버튼** (초록색): PDF만 다운로드
- ✅ 가로 2단 그리드 레이아웃 (태블릿 최적화)
- ✅ 함수 분리:
  - `validateForm()`: 공통 검증 함수
  - `submitEmail()`: 이메일 발송 전용
  - `downloadPDF()`: PDF 생성 전용
- ✅ confirm 다이얼로그 제거 → 명확한 선택 가능
- ✅ 사용자 선택권 강화
- ✅ 각 버튼 독립적으로 작동

### 2026-01-31: PDF 다운로드 기능 추가! 📄 (v1.5.0)
- ✅ 클라이언트 사이드 PDF 생성 (html2pdf.js)
- ✅ 점검표 전체 내용 포함:
  - 시공 정보 (날짜, 차대번호, 제품명 등)
  - 점검 체크리스트 (6개 섹션, 모든 항목)
  - 첨부 사진 (섹션별 그룹화, 고품질)
  - 서명 이미지 (시공자 + 고객)
- ✅ A4 포맷 최적화
- ✅ 파일명 자동 생성: `케이밴_점검표_{차대번호}_{날짜}.pdf`
- ✅ 보관 및 출력 최적화

### 2026-01-31: 다중 이메일 발송 기능 추가! 📧 (v1.4.0)
- ✅ 이메일 주소 최대 3개 입력 가능
- ✅ 이메일 주소 1 (필수) + 2~3 (선택)
- ✅ 입력된 모든 이메일로 동시 발송
- ✅ 발송 성공 시 이메일 개수 표시
- ✅ ChecklistData 타입에 emailList 필드 추가
- ✅ Resend API 배열 전달 방식 적용

### 2026-01-31: 사진 첨부 방식 대폭 개선! 📸 (v1.3.0)
- ✅ 섹션별 통합 사진 버튼으로 변경
- ✅ 여러 장 동시 선택 가능 (multiple)
- ✅ 섹션 제목 옆에 녹색 "사진" 버튼 배치
- ✅ 썸네일 미리보기 (24x24) 및 개별 삭제
- ✅ 각 점검 항목 옆 개별 사진 버튼 제거
- ✅ 섹션별 사진 그룹화 관리

### 2026-01-31: 제품 시공명과 제품 구성 통합! ✨ (v1.2.0)
- ✅ 제품 구성을 체크박스로 선택하는 방식으로 변경
- ✅ 좌우 2단 레이아웃: 기아PV5 (좌) / 밀워키PV5 (우)
- ✅ 각 카테고리 4개 제품씩 제공
- ✅ "기타" 옵션으로 직접 입력 가능

### 2026-01-29: 이메일 서명/사진 표시 문제 해결! 📧
- ✅ Base64 인라인 이미지 → CID 첨부파일로 변경
- ✅ Resend API의 attachments 기능 사용
- ✅ Gmail, Outlook 등 모든 이메일 클라이언트 호환
- ✅ 서명과 사진이 이메일에 정상 표시

## 📞 케이밴 경북지사 정보

- **전화**: 053-XXX-XXXX
- **이메일**: kvan@example.com
- **A/S 보증**: 3년 또는 6만km (선도래 기준)

## 📝 라이선스

© 2026 케이밴. All Rights Reserved.

---

**최종 업데이트**: 2026년 1월 31일  
**개발자**: 사인마스터 (AI 기반 간판 디자인 자동화 전문가)  
**버전**: v1.7.0 (서명 캔버스 좌표 정확도 개선)

### 최신 배포 정보
- **Cloudflare Pages**: ✅ 배포 완료
- **Production URL**: https://kvan-checklist.pages.dev
- **GitHub**: https://github.com/lee1481/kvan-checklist.git
- **Commit**: eafc884 (서명 캔버스 좌표 개선)
- **배포 일시**: 2026-01-31 10:02 UTC
